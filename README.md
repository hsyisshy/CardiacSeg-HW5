# CardiacSeg-HW5: 3D Cardiac Image Segmentation

[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![nnU-Net v2](https://img.shields.io/badge/nnU--Net-v2-green)](https://github.com/MIC-DKFZ/nnUNet)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

æœ¬å°ˆæ¡ˆç‚º **HW5 å¿ƒè‡Ÿå½±åƒåˆ†å‰²ä½œæ¥­** çš„å¯¦ä½œå„²å­˜åº«ã€‚æˆ‘å€‘åŸºæ–¼ **nnU-Net v2** æ¡†æ¶ï¼Œé‡å°å¿ƒè‡Ÿ MRI å½±åƒï¼ˆå·¦å¿ƒå®¤ã€å³å¿ƒå®¤ã€å¿ƒè‚Œï¼‰é–‹ç™¼äº†ä¸€å¥—è‡ªå‹•åŒ–åˆ†å‰²æµç¨‹ã€‚

ğŸ† **æœ€ä½³æˆç¸¾ (V8)**: Dice Score **0.7905**
ğŸš€ **æ ¸å¿ƒç­–ç•¥**: 2D + 3D Lowres Ensemble + Soft Voting + Morphological Post-processing

---

## ğŸ“‹ ç›®éŒ„

- [å¿«é€Ÿé–‹å§‹ (Quick Start)](#-å¿«é€Ÿé–‹å§‹-quick-start)
- [HW5 å°ˆæ¡ˆå ±å‘Š (Project Report)](#-hw5-å°ˆæ¡ˆå ±å‘Š-project-report)
- [ä½¿ç”¨èªªæ˜ (Usage Guide)](#-ä½¿ç”¨èªªæ˜-usage-guide)
- [å°ˆæ¡ˆçµæ§‹ (Project Structure)](#-å°ˆæ¡ˆçµæ§‹-project-structure)
- [å¸¸è¦‹å•é¡Œ (FAQ)](#-å¸¸è¦‹å•é¡Œ-faq)

---

## ğŸš€ å¿«é€Ÿé–‹å§‹ {#quick-start}

### 1. ç’°å¢ƒå®‰è£

æœ¬å°ˆæ¡ˆæä¾›ä¸€éµå®‰è£è…³æœ¬ï¼Œè‡ªå‹•é…ç½® Python è™›æ“¬ç’°å¢ƒã€PyTorch (CUDA/MPS) åŠ nnU-Netã€‚

**Windows (PowerShell)**
```powershell
# 1. å…è¨±åŸ·è¡Œè…³æœ¬
Set-ExecutionPolicy -ExecutionPolicy RemoteSigned -Scope CurrentUser

# 2. åŸ·è¡Œå®‰è£
.\setup_environment.ps1

# 3. å•Ÿç”¨ç’°å¢ƒ
.\.venv\Scripts\Activate.ps1
```

**macOS / Linux**
```bash
# 1. åŸ·è¡Œå®‰è£
chmod +x setup_environment.sh
./setup_environment.sh

# 2. å•Ÿç”¨ç’°å¢ƒ
source .venv/bin/activate
```

### 2. åŸ·è¡Œæµç¨‹

å®‰è£å®Œæˆå¾Œï¼Œè«‹ä¾åºåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼š

```bash
# 1. è³‡æ–™é›†æ¨™æº–åŒ– (è‡ªå‹•ä¸‹è¼‰æˆ–æ•´ç†æ ¼å¼)
python rename_dataset.py

# 2. é–‹å§‹è¨“ç·´ (é è¨­ä½¿ç”¨ 3D Lowres é…ç½®)
python nnunet_train.py --config 3d_lowres --fold 0

# 3. æ¨è«–æ¸¬è©¦é›†
python nnunet_infer.py

# 4. è©•ä¼°çµæœ (éœ€æœ‰ Ground Truth)
python nnunet_evaluate.py
```

---

## ğŸ“ HW5 å°ˆæ¡ˆå ±å‘Š (Project Report)

### 1. æ‘˜è¦ (Abstract)

æœ¬ç ”ç©¶æ—¨åœ¨è§£æ±ºå¿ƒè‡Ÿ MRI å½±åƒçš„è‡ªå‹•åŒ–åˆ†å‰²å•é¡Œï¼Œç›®æ¨™æ˜¯ç²¾ç¢ºåˆ†å‰²å·¦å¿ƒå®¤ (LV)ã€å³å¿ƒå®¤ (RV) åŠå¿ƒè‚Œ (Myocardium)ã€‚æˆ‘å€‘æ¡ç”¨äº†åŸºæ–¼ nnU-Net æ¡†æ¶çš„é›†æˆå­¸ç¿’ç­–ç•¥ã€‚åˆæœŸå¯¦é©—é¡¯ç¤ºå–®ä¸€æ¨¡å‹é›£ä»¥åŒæ™‚å…¼é¡§æ‰€æœ‰çµæ§‹çš„åˆ†å‰²ç²¾åº¦ï¼Œç‰¹åˆ¥æ˜¯å³å¿ƒå®¤çš„è¤‡é›œå½¢ç‹€ã€‚å› æ­¤ï¼Œæˆ‘å€‘æå‡ºäº†ä¸€ç¨®çµåˆ **2D nnU-Net** èˆ‡ **3D Low-resolution nnU-Net** çš„é›†æˆæ–¹æ³•ã€‚

æœ¬å ±å‘Šé‡é»æè¿°æœ€çµ‚å„ªåŒ–ç‰ˆæœ¬ (V8) çš„ç­–ç•¥ï¼šæ¡ç”¨ **Soft Voting (æ©Ÿç‡åŠ æ¬Šé›†æˆ)** å–ä»£å‚³çµ±çš„ç¡¬æ¨™ç±¤æŠ•ç¥¨ï¼Œä¸¦çµåˆ **Test Time Augmentation (TTA)** èˆ‡é‡å°æ€§çš„å¾Œè™•ç† (LCC, Fill Holes, Morphological Closing)ã€‚å¯¦é©—çµæœé¡¯ç¤ºï¼Œæ­¤ç­–ç•¥èƒ½æœ‰æ•ˆçµåˆ 2D æ¨¡å‹åœ¨å¹³é¢è§£æåº¦ä¸Šçš„å„ªå‹¢èˆ‡ 3D æ¨¡å‹åœ¨ç©ºé–“é€£çºŒæ€§ä¸Šçš„å„ªå‹¢ï¼Œå°‡ Dice Score å¾æ—©æœŸçš„ 0.36 å¤§å¹…æå‡è‡³ **0.7905**ã€‚

### 2. æ–¹æ³•è«– (Methodology)

æœ¬ç ”ç©¶çš„æ ¸å¿ƒæ–¹æ³•ç‚º **å¤šè¦–åœ–é›†æˆ (Multi-view Ensemble)** æ­é… **Soft Voting**ã€‚

#### æ¨¡å‹æ¶æ§‹
æˆ‘å€‘è¨“ç·´äº†å…©å€‹ç¨ç«‹çš„ nnU-Net æ¨¡å‹ï¼š
*   **2D nnU-Net**: é€å±¤ (Slice-by-slice) é€²è¡Œåˆ†å‰²ï¼Œè¼¸å…¥å°ºå¯¸ç‚º $512 \times 512$ã€‚æ­¤æ¨¡å‹å°æ–¼é‚Šç·£ç´°ç¯€ï¼ˆç‰¹åˆ¥æ˜¯å³å¿ƒå®¤ï¼‰çš„æ•æ‰èƒ½åŠ›è¼ƒå¼·ã€‚
*   **3D Low-resolution nnU-Net**: å°‡åŸå§‹å½±åƒé™æ¡æ¨£å¾Œé€²è¡Œ 3D å·ç©é‹ç®—ã€‚æ­¤æ¨¡å‹æ“æœ‰æ›´å¤§çš„æ„Ÿå—é‡ (Receptive Field)ï¼Œèƒ½æœ‰æ•ˆç¶­æŒå¿ƒè‡Ÿçµæ§‹çš„ 3D æ‹“æ¨¸æ­£ç¢ºæ€§ï¼ˆå¦‚å¿ƒè‚Œçš„ç’°ç‹€çµæ§‹ï¼‰ã€‚

#### Soft Voting Ensemble (æ©Ÿç‡åŠ æ¬Šé›†æˆ)
é€™æ˜¯ V6 ç‰ˆæœ¬çš„æ ¸å¿ƒæ”¹é€²ã€‚ä¸åŒæ–¼ä¹‹å‰çš„ Hard Voting (ç›´æ¥å°é¡åˆ¥æ¨™ç±¤æŠ•ç¥¨)ï¼ŒSoft Voting æ˜¯å°æ¨¡å‹è¼¸å‡ºçš„ **Softmax æ©Ÿç‡åœ– (Probability Maps)** é€²è¡ŒåŠ æ¬Šå¹³å‡ã€‚

å‡è¨­ $P_{2d}(x)$ å’Œ $P_{3d}(x)$ åˆ†åˆ¥ç‚º 2D å’Œ 3D æ¨¡å‹åœ¨é«”ç´  (Voxel) $x$ è™•é æ¸¬æŸé¡åˆ¥çš„æ©Ÿç‡ï¼Œæœ€çµ‚æ©Ÿç‡ $P_{final}(x)$ å®šç¾©ç‚ºï¼š

$$ P_{final}(x) = w_{2d} \cdot P_{2d}(x) + w_{3d} \cdot P_{3d}(x) $$

æˆ‘å€‘æ ¹æ“šé©—è­‰é›† (Validation Set) çš„è¡¨ç¾ï¼Œé‡å°ä¸åŒè§£å‰–çµæ§‹è¨­è¨ˆäº†ç‰¹å®šçš„æ¬Šé‡çŸ©é™£ $W$ï¼š

| è§£å‰–çµæ§‹ (Label) | 2D æ¬Šé‡ ($w_{2d}$) | 3D æ¬Šé‡ ($w_{3d}$) | è¨­è¨ˆç†ç”± |
| :--- | :---: | :---: | :--- |
| **Background (0)** | 0.5 | 0.5 | ä¸­ç«‹ |
| **Myocardium (1)** | 0.3 | **0.7** | 3D æ¨¡å‹æ›´èƒ½ç¶­æŒå¿ƒè‚Œçš„ç’°ç‹€é€£çºŒæ€§ |
| **Left Ventricle (2)** | 0.3 | **0.7** | 3D æ¨¡å‹å°å·¦å¿ƒå®¤çš„æ•´é«”å½¢ç‹€æŒæ¡è¼ƒä½³ |
| **Right Ventricle (3)** | **0.65** | 0.35 | 2D æ¨¡å‹å°å½¢ç‹€ä¸è¦å‰‡çš„å³å¿ƒå®¤åˆ†å‰²æ›´ç²¾æº– |

#### æ¨è«–å¢å¼·èˆ‡å¾Œè™•ç†
*   **TTA (Test Time Augmentation)**ï¼šæ¨è«–æ™‚é–‹å•Ÿå¤šè»¸å‘é¡åƒç¿»è½‰ï¼Œæ¶ˆé™¤éš¨æ©Ÿèª¤å·®ã€‚
*   **LCC (Keep Largest Connected Component)**ï¼šé‡å°æ¯å€‹é¡åˆ¥åƒ…ä¿ç•™æœ€å¤§é€£é€šå€åŸŸï¼Œç§»é™¤é›œè¨Šã€‚
*   **Fill Holes**ï¼šå¡«è£œå·¦/å³å¿ƒå®¤å…§éƒ¨çš„å­”æ´ã€‚
*   **Morphological Closing**ï¼šä½¿ç”¨å½¢æ…‹å­¸é–‰é‹ç®—å¹³æ»‘é‚Šç·£ (V8 æ–°å¢)ã€‚

### 3. å¯¦é©—éç¨‹èˆ‡æ¼”é€² (Evolution of Approaches)

æˆ‘å€‘çš„æ–¹æ³•ç¶“æ­·äº†å¤šæ¬¡è¿­ä»£ï¼Œä»¥ä¸‹æ˜¯å„éšæ®µçš„é—œéµç™¼ç¾èˆ‡å›°é›£è§£æ±ºï¼š

*   **Phase 1: åˆæœŸå˜—è©¦ (HW3 åŸå§‹ç‰ˆæœ¬)**
    *   **çµæœ**: Dice Score **0.3635** (Underfitting)ã€‚
    *   **å•é¡Œ**: æ¨¡å‹è¨“ç·´ä¸è¶³ï¼Œæœªè™•ç†è³‡æ–™å‹æ…‹èˆ‡ç¶­åº¦å•é¡Œã€‚

*   **Phase 2: Baseline å»ºç«‹**
    *   **æ–¹æ³•**: 2D + 3D Lowres Ensemble (Hard Voting)ã€‚
    *   **çµæœ**: Dice Score **0.7829**ã€‚
    *   **ç™¼ç¾**: è­‰æ˜äº† 2D èˆ‡ 3D Lowres çš„äº’è£œæ€§ã€‚

*   **Phase 3: éŒ¯èª¤çš„å„ªåŒ–æ–¹å‘ (V2/V3)**
    *   **æ–¹æ³•**: å¼•å…¥ 3D Full-resolution æ¨¡å‹ã€‚
    *   **çµæœ**: åˆ†æ•¸ä¸‹é™è‡³ **0.77**ã€‚
    *   **å›°é›£**: 3D Fullres æ¨¡å‹éæ“¬åˆ (Overfitting)ï¼Œä¸”ç™¼ç”Ÿ float/uint8 å‹æ…‹è½‰æ›éŒ¯èª¤ã€‚
    *   **è§£æ±º**: æ”¾æ£„ Fullresï¼Œå°ˆæ³¨æ–¼å„ªåŒ– Lowres èˆ‡ 2D çš„çµåˆï¼Œä¸¦ä¿®å¾©ç¨‹å¼ç¢¼ Bugã€‚

*   **Phase 4 & 5: å›æ­¸èˆ‡ä¿®æ­£ (V4/V5)**
    *   **æ–¹æ³•**: å›æ­¸ 3D Lowres + TTA + LCC/Fill Holesã€‚
    *   **çµæœ**: Dice Score å›å‡è‡³ **0.7833**ã€‚

*   **Phase 6: Soft Voting å„ªåŒ– (Current V6)**
    *   **æ–¹æ³•**: æ”¹ç”¨ **Soft Voting** (æ©Ÿç‡åŠ æ¬Š)ã€‚
    *   **çµæœ**: Dice Score **0.7901**ã€‚
    *   **çªç ´**: æˆåŠŸçªç ´ 0.79 ç“¶é ¸ï¼Œè­‰æ˜ä¿ç•™ä¿¡å¿ƒè³‡è¨Šæ¯”å–®ç´”æŠ•ç¥¨æ›´æœ‰æ•ˆã€‚

*   **Phase 7: éåº¦é›†æˆ (V7)**
    *   **æ–¹æ³•**: å˜—è©¦åŠ å…¥ 3D Fullres (Fold 0 & Fold 1) é€²è¡Œ 4 æ¨¡å‹é›†æˆã€‚
    *   **çµæœ**: Dice Score ä¸‹é™è‡³ **0.7898**ã€‚
    *   **åˆ†æ**: è­‰å¯¦ 3D Fullres æ¨¡å‹åœ¨æ­¤è³‡æ–™é›†ä¸Šè¡¨ç¾ä¸ä½³ï¼ŒåŠ å…¥å¾Œåè€Œå¼•å…¥é›œè¨Šï¼Œæ‹–ç´¯æ•´é«”è¡¨ç¾ã€‚

*   **Phase 8: å½¢æ…‹å­¸å„ªåŒ– (Current V8)**
    *   **æ–¹æ³•**: æ–°å¢ **Morphological Closing**ã€‚
    *   **çµæœ**: Dice Score æå‡è‡³ **0.7905**ã€‚
    *   **çµè«–**: ç´°å¾®çš„å½¢æ…‹å­¸è™•ç†èƒ½é€²ä¸€æ­¥æå‡é‚Šç•Œå“è³ªã€‚

### 4. æœªä¾†å±•æœ› (Future Work)
ç›®å‰çš„å„ªåŒ–å·²å°‡å–®ä¸€ Fold (Fold 0) çš„æ½›åŠ›ç™¼æ®è‡³æ¥µé™ã€‚ç‚ºäº†çªç ´ 0.80 çš„å¤§é—œï¼Œæˆ‘å€‘å·²å•Ÿå‹• **5-Fold Cross Validation** è¨ˆç•«ï¼Œé æœŸé€éæ¶ˆé™¤è³‡æ–™åˆ‡åˆ†çš„åå·®ï¼Œèƒ½é€²ä¸€æ­¥æå‡æ¨¡å‹çš„æ³›åŒ–èƒ½åŠ›ã€‚

---

## ğŸ“– ä½¿ç”¨èªªæ˜ (Usage Guide)

### è¨“ç·´ç­–ç•¥å»ºè­°
é‡å°æœ‰é™çš„é‹ç®—è³‡æºï¼Œæˆ‘å€‘å»ºè­°ä»¥ä¸‹æ¼¸é€²å¼ç­–ç•¥ï¼š

| éšæ®µ | é…ç½® (`--config`) | Epochs | ç›®çš„ |
|------|-------------------|--------|------|
| **å¿«é€Ÿé©—è­‰** | `2d` | 50-80 | ç¢ºèªæµç¨‹è·‘é€šï¼Œæª¢æŸ¥æ¨™ç±¤æ­£ç¢ºæ€§ |
| **ä¸»åŠ›æ¨¡å‹** | `3d_lowres` | 150-250 | å–å¾—ä¸éŒ¯çš„ Baselineï¼Œè¨“ç·´é€Ÿåº¦é©ä¸­ |
| **è¿½æ±‚æ¥µè‡´** | `3d_fullres` | 300+ | æå‡é‚Šç•Œç´°ç¯€ (éœ€è¼ƒå¤šæ™‚é–“èˆ‡é¡¯å­˜) |

**æŒ‡ä»¤ç¯„ä¾‹**:
```bash
# è¨“ç·´ 2D æ¨¡å‹ (å¿«é€Ÿ)
python nnunet_train.py --config 2d --epochs 100

# è¨“ç·´ 3D Lowres æ¨¡å‹ (æ¨è–¦)
python nnunet_train.py --config 3d_lowres --epochs 250
```

### ç›£æ§è¨“ç·´
å°ˆæ¡ˆå…§å»º `monitor_training_live.ps1` (Windows) å¯å³æ™‚ç›£æ§è¨“ç·´é€²åº¦èˆ‡ GPU ä½¿ç”¨ç‡ã€‚

```powershell
.\monitor_training_live.ps1
```

---

## ğŸ“ å°ˆæ¡ˆçµæ§‹

```text
CardiacSeg/
â”œâ”€â”€ setup_environment.ps1      # Windows å®‰è£è…³æœ¬
â”œâ”€â”€ setup_environment.sh       # macOS/Linux å®‰è£è…³æœ¬
â”œâ”€â”€ rename_dataset.py          # è³‡æ–™å‰è™•ç†
â”œâ”€â”€ nnunet_train.py            # è¨“ç·´ä¸»ç¨‹å¼
â”œâ”€â”€ nnunet_infer.py            # æ¨è«–ä¸»ç¨‹å¼
â”œâ”€â”€ nnunet_evaluate.py         # è©•ä¼°ç¨‹å¼
â”œâ”€â”€ run_optimized_submission_v8.py # (V8) æœ€ä½³åŒ–é›†æˆè…³æœ¬
â”œâ”€â”€ nnUNet_raw/                # åŸå§‹è³‡æ–™å­˜æ”¾å€
â”œâ”€â”€ nnUNet_preprocessed/       # é è™•ç†å¾Œè³‡æ–™
â””â”€â”€ nnUNet_results/            # æ¨¡å‹æ¬Šé‡èˆ‡é æ¸¬çµæœ
```

---

## â“ å¸¸è¦‹å•é¡Œ (FAQ)

**Q: é‡åˆ° `CUDA out of memory` æ€éº¼è¾¦ï¼Ÿ**
A: è«‹å˜—è©¦æ”¹ç”¨ `3d_lowres` æˆ– `2d` é…ç½®ï¼Œæˆ–åœ¨ `nnunet_train.py` ä¸­æ¸›å°‘ batch sizeã€‚

**Q: å¦‚ä½•ä½¿ç”¨æœ€ä½³çš„ V8 é›†æˆæ¨¡å‹ï¼Ÿ**
A: è«‹åŸ·è¡Œ `python run_optimized_submission_v8.py`ï¼Œæ­¤è…³æœ¬æœƒè‡ªå‹•è¼‰å…¥è¨“ç·´å¥½çš„ 2D èˆ‡ 3D æ¨¡å‹ä¸¦é€²è¡Œ Soft Voting é›†æˆã€‚

---

## ğŸ”— åƒè€ƒè³‡æ–™
*   [nnU-Net GitHub](https://github.com/MIC-DKFZ/nnUNet)
*   Isensee, F., et al. "nnU-Net: a self-configuring method for deep learning-based biomedical image segmentation." *Nature Methods* (2021).
